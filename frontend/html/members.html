<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Members</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/members.css">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">Gym Management System</div>
    <nav>
        <a href="dashboard.html" class="nav-item-admin"><i class="ph ph-house"></i> Dashboard</a>
        <a href="members.html" class="nav-item-all"><i class="ph ph-users"></i> Members</a>
        <a href="coaches.html" class="nav-item-all"><i class="ph ph-user"></i> Coaches</a>
        <a href="payments.html" class="nav-item-admin"><i class="ph ph-coins"></i> Payment History</a>
        <a href="schedules.html" class="nav-item-all"><i class="ph ph-calendar"></i> Schedules</a>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <div class="main">

    <!-- Header -->
    <header class="topbar">
      <button id="toggleSidebar" class="menu-btn">‚ò∞</button>
      <h1>Members</h1>
      <div class="user-menu">
        <div class="user-profile-dropdown">
          <button class="user-profile-btn" id="userProfileBtn" onclick="toggleUserDropdown()">
            <div class="user-avatar" id="userAvatar">U</div>
            <span id="userName">User</span>
            <i class="ph ph-caret-down"></i>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <div class="user-dropdown-header">
              <div class="user-dropdown-avatar" id="userDropdownAvatar">U</div>
              <div class="user-dropdown-info">
                <div class="user-dropdown-name" id="userDropdownName">User</div>
                <div class="user-dropdown-email" id="userDropdownEmail">user@example.com</div>
                <div class="user-dropdown-role" id="userDropdownRole"></div>
              </div>
            </div>
            <div class="user-dropdown-divider"></div>
            <button class="user-dropdown-item" onclick="logout()">
              <i class="ph ph-sign-out"></i>
              <span>Log out</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Dashboard Content -->
    <section class="content">

      <div class="page-header">
        <h2>Members Management</h2>
        <div class="header-buttons">
          <button id="addMemberBtn" class="btn-primary" style="display: none;">
            <i class="ph ph-plus"></i> Add Member
          </button>
          <button id="renewMemberBtn" class="btn-renew" style="display: none;">
            <i class="ph ph-arrows-clockwise"></i> Renew
          </button>
        </div>
      </div>


      <div class="members-stats">
        <div class="stat-card">
          <h3>Total Members</h3>
          <p id="totalMembers" class="stat-number">0</p>
        </div>
        <div class="stat-card">
          <h3>Active Members</h3>
          <p id="activeMembers" class="stat-number">0</p>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="members-header">
        <div class="search-filter-container">
          <div class="search-box">
            <i class="ph ph-magnifying-glass"></i>
            <input type="text" id="searchInput" placeholder="Search by name, email, or phone...">
          </div>
          
          <div class="filter-group">
            <div class="filter-item">
              <label for="membershipTypeFilter">
                <i class="ph ph-tag"></i> Membership:
              </label>
              <select id="membershipTypeFilter" onchange="applyFilters()">
                <option value="">All Memberships</option>
                <option value="Trial">Trial</option>
                <option value="Monthly">Monthly</option>
                <option value="Annual">Annual</option>
                <option value="Monthly with Coach">Monthly with Coach</option>
                <option value="Annual with Coach">Annual with Coach</option>
              </select>
            </div>

            <div class="filter-item">
              <label for="statusFilter">
                <i class="ph ph-check-circle"></i> Status:
              </label>
              <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="expired">Expired</option>
              </select>
            </div>

            <div class="filter-item">
              <label for="sortSelect">
                <i class="ph ph-sort-ascending"></i> Sort by:
              </label>
              <select id="sortSelect" onchange="applyFilters()">
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="date-newest">Join Date (Newest)</option>
                <option value="date-oldest">Join Date (Oldest)</option>
                <option value="status">Status</option>
              </select>
            </div>

            <button class="btn-clear-filters" onclick="clearAllFilters()">
              <i class="ph ph-x"></i> Clear Filters
            </button>
          </div>
        </div>
      </div>

      <div class="members-table">
        <table id="membersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Membership Type</th>
              <th>Coach</th>
              <th>Status</th>
              <th>Join Date</th>
              <th>Expiration Date</th>
              <th class="admin-only" style="display: none;">Actions</th>
            </tr>
          </thead>
          <tbody id="membersTableBody">
            <tr>
              <td colspan="9" style="text-align: center; padding: 40px;">
                <i class="ph ph-spinner ph-spin" style="font-size: 32px;"></i>
                <p>Loading members...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </section>

    <!-- Add/Edit Member Modal -->
    <div id="memberModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add New Member</h2>
          <span class="close">&times;</span>
        </div>
        <form id="memberForm">
          <input type="hidden" id="memberId">
          
          <div class="form-group">
            <label for="membershipType">Membership Type *</label>
            <select id="membershipType" required>
              <option value="">Select Membership Type</option>
              <option value="Trial">Trial (1 day)</option>
              <option value="Monthly">Monthly (30 days)</option>
              <option value="Annual">Annual (365 days)</option>
              <option value="Monthly with Coach">Monthly with Coach (30 days)</option>
              <option value="Annual with Coach">Annual with Coach (365 days)</option>
            </select>
            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
              <span id="membershipTypeHint">Choose a membership type to see required fields</span>
            </small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="isStudent">
              <span>Student (10% discount)</span>
            </label>
          </div>

          <div class="form-group">
            <label for="memberName">Full Name *</label>
            <input type="text" id="memberName" required placeholder="Enter member name">
          </div>

          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label for="memberPhone">Phone Number <span id="phoneRequired">*</span></label>
              <input type="tel" id="memberPhone" required maxlength="11" 
                     placeholder="e.g., 09123456789" value="09" style="width: 100%;">
              <small style="color: #666; font-size: 12px;">e.g., 09123456789</small>
            </div>

            <div class="form-group" style="flex: 1;">
              <label for="memberAge">Age *</label>
              <input type="text" id="memberAge" required maxlength="3" 
                     placeholder="Age" pattern="[0-9]*"
                     oninput="this.value = this.value.replace(/[^0-9]/g, '')" style="width: 100%;">
            </div>
          </div>

          <div class="form-group dynamic-field" id="emailField">
            <label for="memberEmail">Email *</label>
            <input type="email" id="memberEmail" required placeholder="Enter email address">
          </div>

          <div class="form-group dynamic-field" id="passwordField">
            <label for="memberPassword">Password (for login account) *</label>
            <input type="password" id="memberPassword" required minlength="6" placeholder="Minimum 6 characters">
            <small style="color: #666;">This will create a login account for the member</small>
          </div>

          <div class="form-group dynamic-field" id="addressField">
            <label for="memberAddress">
              Address 
              <span class="optional-tooltip" title="This field is optional">
                <i class="ph ph-question"></i>
              </span>
            </label>
            <textarea id="memberAddress" rows="3" placeholder="Enter address"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group dynamic-field" id="emergencyField">
              <label for="emergencyContactName">
                Emergency Contact Name 
                <span class="optional-tooltip" title="This field is optional">
                  <i class="ph ph-question"></i>
                </span>
              </label>
              <input type="text" id="emergencyContactName" placeholder="Full name of emergency contact">
            </div>

            <div class="form-group dynamic-field" id="emergencyPhoneField">
              <label for="emergencyContactPhone">
                Phone 
                <span class="optional-tooltip" title="This field is optional">
                  <i class="ph ph-question"></i>
                </span>
              </label>
              <input type="tel" id="emergencyContactPhone" maxlength="11" 
                     placeholder="e.g., 09123456789" value="09">
              <small style="color: #666; font-size: 12px;">e.g., 09123456789</small>
            </div>
          </div>

          <div class="form-group" id="statusField" style="display: none;">
            <label for="memberStatus">Status</label>
            <select id="memberStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          <!-- Change Coach Section (for editing members with coaches) -->
          <div class="form-group" id="changeCoachField" style="display: none;">
            <label>Current Coach</label>
            <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f5f5f5; border-radius: 6px; margin-bottom: 10px;">
              <i class="ph ph-user" style="font-size: 20px; color: #4CAF50;"></i>
              <span id="currentCoachName" style="font-weight: 500;">N/A</span>
            </div>
            <button type="button" onclick="openChangeCoachModal()" class="btn-secondary" style="width: 100%;">
              <i class="ph ph-arrows-clockwise"></i> Change Coach
            </button>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeMemberModal()">Cancel</button>
            <button type="submit" class="btn-primary">
              <span id="submitBtnText">Add Member</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Choose Coach Modal -->
    <div id="coachModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h2>Choose a Coach</h2>
          <span class="close" onclick="closeCoachModal()">&times;</span>
        </div>
        <div class="coach-selection-info">
          <p><strong>Member:</strong> <span id="coachSelectionMemberName"></span></p>
          <p><strong>Membership:</strong> <span id="coachSelectionMembershipType"></span></p>
        </div>
        <div id="coachList" class="coach-list">
          <div style="text-align: center; padding: 40px;">
            <i class="ph ph-spinner ph-spin" style="font-size: 32px;"></i>
            <p>Loading coaches...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
      <div class="modal-content payment-modal-content">
        <div class="modal-header">
          <h2><i class="ph ph-currency-dollar"></i> Payment Information</h2>
          <span class="close" onclick="closePaymentModal()">&times;</span>
        </div>
        <form id="paymentForm">
          <input type="hidden" id="paymentMemberId">
          <input type="hidden" id="paymentMemberName">
          <input type="hidden" id="paymentMembershipType">
          <input type="hidden" id="paymentIsStudent">
          
          <div class="payment-summary-card">
            <h3><i class="ph ph-receipt"></i> Membership Summary</h3>
            <div class="summary-row">
              <span class="summary-label">Member:</span>
              <span class="summary-value" id="paymentSummaryName"></span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Membership Type:</span>
              <span class="summary-value" id="paymentSummaryType"></span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Coach:</span>
              <span class="summary-value" id="paymentSummaryCoach">N/A</span>
            </div>
            <div class="summary-row" id="studentDiscountRow" style="display: none;">
              <span class="summary-label"><i class="ph ph-student"></i> Student Discount (10%):</span>
              <span class="summary-value discount-text" id="studentDiscountAmount">-‚Ç±0.00</span>
            </div>
            <div class="summary-row total-row">
              <span class="summary-label">Total Amount:</span>
              <span class="summary-value amount-highlight" id="paymentSummaryAmount"></span>
            </div>
          </div>

          <div class="form-group">
            <label for="paymentAmount">Amount (Read-only) *</label>
            <input type="text" id="paymentAmount" readonly class="readonly-input">
          </div>

          <div class="form-group">
            <label for="paymentNotes">
              <i class="ph ph-note"></i> Notes 
              <span class="optional-tooltip" title="This field is optional">
                <i class="ph ph-question"></i>
              </span>
            </label>
            <textarea id="paymentNotes" rows="3" placeholder="Additional payment notes..."></textarea>
          </div>

          <div class="modal-actions" style="justify-content: center; padding: 0 20px;">
            <button type="button" class="btn-secondary" onclick="closePaymentModal()">
              <i class="ph ph-arrow-left"></i> Back
            </button>
            <button type="submit" class="btn-primary">
              <i class="ph ph-check-circle"></i> Process Payment
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Success Toast Notification -->
    <div id="successToast" class="success-toast">
      <div class="toast-content">
        <i class="ph ph-check-circle toast-icon"></i>
        <div class="toast-message">
          <strong>Payment Successful!</strong>
          <p>Payment has been processed successfully.</p>
        </div>
      </div>
    </div>

    <!-- Renew Membership Modal -->
    <div id="renewModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Renew Membership</h2>
          <span class="close" onclick="closeRenewModal()">&times;</span>
        </div>
        <form id="renewForm">
          <!-- Step 1: Select Member -->
          <div class="form-group">
            <label for="renewMemberSelect"><i class="ph ph-user"></i> Select Member *</label>
            <select id="renewMemberSelect" required onchange="handleRenewMemberSelection(this.value)">
              <option value="">-- Select a member to renew --</option>
            </select>
          </div>
          <input type="hidden" id="renewMemberId">

          <!-- Step 2: Display Current Status Card -->
          <div id="renewMemberInfo" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
            <h4 style="margin: 0 0 16px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">Current Status</h4>
            <div style="background: rgba(255,255,255,0.15); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="opacity: 0.9;">Member:</span>
                <strong id="renewInfoName" style="font-size: 16px;"></strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="opacity: 0.9;">Current Plan:</span>
                <strong id="renewInfoType"></strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="opacity: 0.9;">Status:</span>
                <strong id="renewInfoStatus" style="padding: 4px 12px; border-radius: 20px; background: rgba(255,255,255,0.2);"></strong>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="opacity: 0.9;">Expires:</span>
                <strong id="renewInfoExpiration"></strong>
              </div>
            </div>
          </div>

          <!-- Step 3: Select New Membership Type -->
          <div class="form-group" id="renewMembershipTypeGroup" style="display: none;">
            <label for="renewMembershipType"><i class="ph ph-shopping-bag"></i> New Membership Type *</label>
            <select id="renewMembershipType" required>
              <option value="">-- Select New Plan --</option>
              <option value="Monthly">üí≥ Monthly - ‚Ç±1,000 (30 days)</option>
              <option value="Annual">üíé Annual - ‚Ç±10,000 (365 days)</option>
              <option value="Monthly with Coach">üèãÔ∏è Monthly with Coach - ‚Ç±2,000 (30 days)</option>
              <option value="Annual with Coach">‚≠ê Annual with Coach - ‚Ç±20,000 (365 days)</option>
            </select>
          </div>

          <!-- Student Discount Option -->
          <div class="form-group" id="renewStudentGroup" style="display: none;">
            <label class="checkbox-label">
              <input type="checkbox" id="renewIsStudent">
              <span style="font-weight: 600;"><i class="ph ph-student"></i> Apply Student Discount (10% off)</span>
            </label>
          </div>

          <!-- Payment Summary -->
          <div id="renewPaymentInfo" style="display: none; background: #f8f9fa; border: 2px solid #667eea; padding: 20px; border-radius: 8px; margin: 20px 0;">
            <h4 style="margin: 0 0 12px 0; color: #667eea; font-size: 16px;"><i class="ph ph-coins"></i> Payment Summary</h4>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #333;">
              <span>Base Amount:</span>
              <strong id="renewBaseAmount">‚Ç±0.00</strong>
            </div>
            <div id="renewDiscountRow" style="display: none; justify-content: space-between; margin-bottom: 8px; color: #e74c3c;">
              <span>Student Discount (10%):</span>
              <strong id="renewDiscountAmount">-‚Ç±0.00</strong>
            </div>
            <hr style="border: none; border-top: 2px solid #e0e0e0; margin: 12px 0;">
            <div style="display: flex; justify-content: space-between; color: #667eea; font-size: 18px;">
              <span style="font-weight: 600;">Total Amount:</span>
              <strong id="renewTotalAmount" style="font-size: 22px;">‚Ç±0.00</strong>
            </div>
          </div>

          <!-- Notes Field -->
          <div id="renewPaymentFields" style="display: none;">
            <div class="form-group">
              <label for="renewPaymentNotes">
                <i class="ph ph-note"></i> Notes (Optional)
              </label>
              <textarea id="renewPaymentNotes" rows="3" placeholder="Add any notes about this renewal..."></textarea>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeRenewModal()">
              <i class="ph ph-x"></i> Cancel
            </button>
            <button type="submit" class="btn-primary" id="renewSubmitBtn">
              <i class="ph ph-check-circle"></i> <span id="renewSubmitBtnText">Process Renewal</span>
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <script src="/js/auth-check.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/members.js"></script>
</body>
</html>

